<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link rel="stylesheet" href="../css/dashboard.css">

<link rel="stylesheet"
href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<!-- =========================
     SIDEBAR
========================= -->

<aside class="sidebar">

  <div class="sidebar-header">
    <div class="logo-circle">
      <img src="../assets/logo.png" class="sidebar-logo">
    </div>
    <h2>VetCare</h2>
  </div>

  <hr class="sidebar-divider">

  <nav>
    <a href="Dashboard.html" class="active">
      <span class="material-symbols-outlined">home</span>
      Painel
    </a>

    <a href="CadastroTutor.html">
      <span class="material-symbols-outlined">add</span>
      Cadastrar Tutor
    </a>

    <a href="CadastroAnimal.html">
      <span class="material-symbols-outlined">add</span>
      Cadastrar Animal
    </a>

    <a href="ListarAnimais.html">
      <span class="material-symbols-outlined">pets</span>
      Listar Animais
    </a>

    <a href="ListarTutores.html">
      <span class="material-symbols-outlined">group</span>
      Listar Tutores
    </a>

    <a href="VacinasPendentes.html">
      <span class="material-symbols-outlined">vaccines</span>
      Vacinas Pendentes
    </a>

    <a href="Relatorios.html">
      <span class="material-symbols-outlined">description</span>
      Relat√≥rios
    </a>

    <a href="../index.html">
      <span class="material-symbols-outlined">logout</span>
      Sair
    </a>
  </nav>

</aside>

<!-- =========================
     CONTE√öDO
========================= -->

<main class="content">

<h1>Painel</h1>
<p class="subtitle">Bem-vinda, <span id="nomeUsuario"></span> üëã</p>

<!-- CARDS -->

<div class="cards-container">

  <div class="card animais">
    <div class="card-text">
      <span class="title">Total de Animais</span>
      <span class="count" id="totalAnimais">0</span>
      <span class="subtitle">Cadastrados no sistema</span>
    </div>
    <div class="card-icon-box">
      <img src="../assets/logo.png">
    </div>
  </div>

  <div class="card vacinas-dia">
    <div class="card-text">
      <span class="title">Vacinas em Dia</span>
      <span class="count" id="vacinasEmDia">0</span>
      <span class="subtitle">Animais vacinados</span>
    </div>
    <div class="card-icon-box">
      <img src="../assets/images.png">
    </div>
  </div>

  <div class="card proximas-vencimento">
    <div class="card-text">
      <span class="title">Pr√≥x. do Vencimento</span>
      <span class="count" id="vacinasProximas">0</span>
      <span class="subtitle">Aten√ß√£o necess√°ria</span>
    </div>
    <div class="card-icon-box">
      <img src="../assets/0be97ed532babd9e473dd97ec4fee170.png">
    </div>
  </div>

  <div class="card pendentes">
    <div class="card-text">
      <span class="title">Vacinas Pendentes</span>
      <span class="count" id="vacinasPendentes">0</span>
      <span class="subtitle">Requerem a√ß√£o</span>
    </div>
    <div class="card-icon-box">
      <img src="../assets/‚ÄîPngtree‚Äîred warning sign icon_6686804.png">
    </div>
  </div>

</div>

<!-- GR√ÅFICOS -->

<div class="graficos-grid">

  <div class="form-card">
    <h2>Vacina√ß√µes nos √öltimos Meses</h2>
    <div class="grafico-container">
        <canvas id="graficoVacinas"></canvas>
    </div>
  </div>

  <div class="form-card">
    <h2>Desempenho da Cl√≠nica (Novos Cadastros)</h2>
    <div class="grafico-container">
      <canvas id="graficoDesempenho"></canvas>
    </div>
  </div>

</div>

<!-- TABELA -->

<div class="form-card">
<h2>Animais Atendidos no M√™s</h2>
<table>
<thead>
<tr>
<th>Nome</th>
<th>Esp√©cie</th>
<th>Ra√ßa</th>
<th>Data Atendimento</th>
</tr>
</thead>
<tbody id="tabelaAtendidos">
</tbody>
</table>
</div>

</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    try {
        const resposta = await fetch("http://localhost:3000/dashboard");
        const dados = await resposta.json();

        // Preenchimento dos cards e nome
        document.getElementById("nomeUsuario").innerText = dados.nome || "Veterin√°rio(a)";
        document.getElementById("totalAnimais").innerText = dados.totalAnimais;
        document.getElementById("vacinasEmDia").innerText = dados.vacinasEmDia;
        document.getElementById("vacinasProximas").innerText = dados.vacinasProximas;
        document.getElementById("vacinasPendentes").innerText = dados.vacinasPendentes;

        // Preenchimento da Tabela
        const tbody = document.getElementById("tabelaAtendidos");
        tbody.innerHTML = ""; // Limpa antes de preencher
        dados.tabelaAtendidos.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.nome}</td>
                <td>${row.especie}</td>
                <td>${row.raca}</td>
                <td>${new Date(row.data_aplicacao).toLocaleDateString("pt-BR")}</td>
            `;
            tbody.appendChild(tr);
        });

        // --- TRATAMENTO DOS DADOS PARA OS GR√ÅFICOS ---
        const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

        // Criamos arrays de 12 posi√ß√µes zeradas
        const vacinasArray = new Array(12).fill(0);
        const desempenhoArray = new Array(12).fill(0);

        // Mapeamos os dados do banco para a posi√ß√£o correta (m√™s - 1)
        if (dados.vacinasMes) {
            dados.vacinasMes.forEach(v => {
                vacinasArray[v.mes - 1] = v.total;
            });
        }

        if (dados.desempenhoMes) {
            dados.desempenhoMes.forEach(d => {
                desempenhoArray[d.mes - 1] = d.total;
            });
        }

        // --- GR√ÅFICO DE VACINAS ---
        new Chart(document.getElementById('graficoVacinas'), {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [{
                    label: 'Vacina√ß√µes',
                    data: vacinasArray, // Agora passamos a array de n√∫meros
                    backgroundColor: 'hsl(158, 83%, 30%)',
                    borderColor: 'hsla(158, 83%, 19%, 0.763)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // --- GR√ÅFICO DE DESEMPENHO ---
        new Chart(document.getElementById('graficoDesempenho'), {
            type: 'line',
            data: {
                labels: meses,
                datasets: [{
                    label: 'Novos Cadastros',
                    data: desempenhoArray, // Agora passamos a array de n√∫meros
                    tension: 0.3,
                    borderColor: 'hsl(158, 83%, 30%)',
                    backgroundColor: 'rgba(16,185,129,0.15)',
                    fill: true,
                    borderWidth: 3,
                    pointBackgroundColor: '#059669',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

    } catch (error) {
        console.error("Erro ao carregar dashboard:", error);
    }
});
</script>

</body>
</html>